<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>People Contribution Files</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      padding: 2rem;
      background: #f8f8f8;
    }
    .card {
      border-radius: 1rem;
      margin-bottom: 1.5rem;
    }
    .file-link {
      cursor: pointer;
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="mb-4 text-primary">ðŸ“‚ Contribution Files</h2>

    <!-- Create New File -->
    <div class="card p-4 mb-4">
      <h4>Create New File</h4>
      <div class="row g-3">
        <div class="col-md-6">
          <input id="fileName" type="text" class="form-control" placeholder="File Name (e.g. Easter Fund)" />
          <div id="fileNameError" class="text-danger small mt-1"></div>
        </div>
        <div class="col-md-4">
          <input id="fileDate" type="date" class="form-control" />
          <div id="fileDateError" class="text-danger small mt-1"></div>
        </div>
        <div class="col-md-2">
          <button class="btn btn-primary w-100" onclick="createFile()">Create</button>
        </div>
      </div>
    </div>

    <!-- File List -->
    <h4>Existing Files</h4>
    <ul id="fileList" class="list-group mb-4"></ul>

    <!-- People Management Section -->
    <div class="card p-4" id="peopleSection" style="display: none;">
      <h4 id="selectedFileTitle"></h4>
      <div class="input-group mb-3">
        <input id="personName" type="text" class="form-control" placeholder="Add person name" />
        <button class="btn btn-success" onclick="addPerson()">Add</button>
      </div>
      <ul id="peopleList" class="list-group"></ul>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAYwi8LehN7DpwlA7kEt-r3CFMetxVoZJI",
      authDomain: "churchledger-64200.firebaseapp.com",
      projectId: "churchledger-64200",
      storageBucket: "churchledger-64200.appspot.com",
      messagingSenderId: "16697753870",
      appId: "1:16697753870:web:306935c049ac213bfa175f",
      measurementId: "G-RECFK377Y8"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let contributions = {};
    let selectedFileId = null;

    function loadFiles() {
      db.collection("contributionFiles").orderBy("date", "desc").get()
        .then(snapshot => {
          contributions = {};
          snapshot.forEach(doc => {
            contributions[doc.id] = doc.data();
          });
          renderFiles();
        });
    }

    function renderFiles() {
      const list = document.getElementById('fileList');
      list.innerHTML = '';
      if (Object.keys(contributions).length === 0) {
        list.innerHTML = '<li class="list-group-item">No files created yet.</li>';
        return;
      }

      Object.entries(contributions).forEach(([id, data]) => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.innerHTML = `<span class="file-link" onclick="selectFile('${id}')">${data.name} | ${data.date}</span> <span class="badge bg-secondary">${(data.people || []).length} people</span>`;
        list.appendChild(li);
      });
    }

    function createFile() {
      const name = document.getElementById('fileName').value.trim();
      const date = document.getElementById('fileDate').value.trim();
      document.getElementById('fileNameError').textContent = name ? '' : 'File name required';
      document.getElementById('fileDateError').textContent = date ? '' : 'Date required';

      if (!name || !date) return;

      db.collection("contributionFiles").add({ name, date, people: [], createdAt: firebase.firestore.FieldValue.serverTimestamp() })
        .then(() => {
          document.getElementById('fileName').value = '';
          document.getElementById('fileDate').value = '';
          loadFiles();
        });
    }

    function selectFile(id) {
      selectedFileId = id;
      const file = contributions[id];
      document.getElementById('peopleSection').style.display = 'block';
      document.getElementById('selectedFileTitle').textContent = `People for: ${file.name}`;
      document.getElementById('personName').value = '';
      renderPeople(file.people || []);
    }

    function renderPeople(people) {
      const list = document.getElementById('peopleList');
      list.innerHTML = '';
      people.forEach((person, index) => {
        const li = document.createElement('li');
        li.className = 'list-group-item';
        li.textContent = person;
        list.appendChild(li);
      });
    }

    function addPerson() {
      const person = document.getElementById('personName').value.trim();
      if (!person) return;

      const file = contributions[selectedFileId];
      const updatedPeople = [...(file.people || []), person];

      db.collection('contributionFiles').doc(selectedFileId).update({ people: updatedPeople })
        .then(() => {
          contributions[selectedFileId].people = updatedPeople;
          document.getElementById('personName').value = '';
          renderPeople(updatedPeople);
          renderFiles();
        });
    }

    window.addEventListener('DOMContentLoaded', loadFiles);
  </script>
</body>
</html>
